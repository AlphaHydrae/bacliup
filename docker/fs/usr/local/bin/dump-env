#!/usr/bin/env sh
set -e

dump_dir=/var/run/bacliup/environment
variables_to_dump="$@"

if ! mkdir -p "$dump_dir"; then
  >&2 echo "Could not create $dump_dir directory"
  exit 1
fi

if ! chmod 700 "$dump_dir"; then
  >&2 echo "Could not change $dump_dir permissions"
  exit 1
fi

for variable_to_dump in $variables_to_dump; do
  echo "Dumping \$$variable_to_dump to $dump_dir..."
  if ! (umask 0277 && printenv "$variable_to_dump" > "$dump_dir/$variable_to_dump"); then
    >&2 echo "Warning: variable $variable_to_dump is not set"
  fi
done
